<!DOCTYPE html>

<html>

<head>
	<title>Warhammer 40k</title>

	<style>
	</style>

	<script>
		var models = []

		function updateTroopTable() {
			var request = new XMLHttpRequest()
			request.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					var response = JSON.parse(request.responseText)
					console.log(typeof response.value)
					document.getElementById("troops").innerHTML = response.value
				}
			}
			request.open("POST", "resources/models.json", true)
			request.send()
		}

		function fetchModelList() {
			var request = new XMLHttpRequest()
			request.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					console.log("Get Model List request received")
					var modelList = JSON.parse(request.responseText)
					console.log(modelList)
					document.getElementById("model-selector").innerHTML = ""
					for (model in modelList) {
						var option = document.createElement("option")
						option.innerHTML = modelList[model]
						document.getElementById("model-selector").add(option)
					}
					document.getElementById("army-table").setAttribute("hidden", true)
					document.getElementById("unit-builder").removeAttribute("hidden")
				}
			}
			request.open("POST", "/fetchModelList")
			request.send()
		}

		function fetchModelStats() {
			var request = new XMLHttpRequest()
			request.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					console.log("Fetch Model Stats request received")
					var modelStats = JSON.parse(request.responseText)
					displayStats(modelStats)
				}
			}
			request.open("POST", "/fetchModelStats")
			request.setRequestHeader("Content-Type", "application/json");
			request.send(JSON.stringify({ "model": document.getElementById("model-selector").value }))
		}

		function fetchArmy() {
			var request = new XMLHttpRequest()
			request.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					console.log("Fetch Army request received")
					document.getElementById("army-table").removeAttribute("hidden")
					document.getElementById("unit-builder").setAttribute("hidden", true)
					console.log(JSON.parse(request.responseText))
					var army = JSON.parse(request.responseText)
					generateArmyTable(army)
				}
			}
			request.open("POST", "/fetchArmy")
			request.send()
		}

		function addModel() {
			var model = document.getElementById("model-selector").value
			models.push(model)
			document.getElementById("model-stats").setAttribute("hidden", true)
			document.getElementById("submit-unit").removeAttribute("disabled")
			generateUnitTable(models)
		}

		function removeModel(index) {
			models.splice(index, 1)
			if (models.length == 0) {
				document.getElementById("submit-unit").setAttribute("disabled", true)
			}
			generateUnitTable(models)
		}

		function displayStats(modelStats) {
			document.getElementById("model-stats").innerHTML = ""
			var row1 = document.createElement("tr")
			var row2 = document.createElement("tr")
			for (key in modelStats) {
				var th = document.createElement("th")
				th.innerText = key
				row1.appendChild(th)
				var td = document.createElement("td")
				td.innerText = modelStats[key]
				row2.appendChild(td)
			}
			document.getElementById("model-stats").appendChild(row1)
			document.getElementById("model-stats").appendChild(row2)
			document.getElementById("model-stats").removeAttribute("hidden")
		}

		function generateUnitTable(unit) {
			var table = document.createElement("table")
			table.id = "unit-models"
			unit.forEach(element => {
				var row = document.createElement("tr")
				var remove = document.createElement("td")
				var name = document.createElement("td")
				remove.innerHTML = `<button onclick='removeModel(${models.indexOf(element)})'>Remove</button>`
				name.innerHTML = element
				row.appendChild(remove)
				row.appendChild(name)
				table.appendChild(row)
			});
			document.getElementById("unit-models").replaceWith(table)
		}
		function generateArmyTable(army) {
			var table = document.createElement("table")
			table.id = "army-table"
			army.forEach(unit => {
				var tr = document.createElement("tr")
				var th = document.createElement("th")
				th.innerText = `Unit ${army.indexOf(unit) + 1} - ${unit.role}`
				tr.appendChild(th)
				table.appendChild(tr)
				unit.models.forEach(model => {
					var tr = document.createElement("tr")
					tr.insertCell(0)
					var td = tr.insertCell(-1)
					td.innerText = model.name
					table.appendChild(tr)
				})
			})
			document.getElementById("army-table").replaceWith(table)
		}

		function createUnit() {
			var request = new XMLHttpRequest()
			request.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					console.log("Save Unit request received")
					models = []
					document.getElementById("unit-models").innerHTML = ""
					document.getElementById("submit-unit").setAttribute("disabled", true)
				}
			}
			request.open("POST", "/createUnit")
			request.setRequestHeader("Content-Type", "application/json")
			request.send(JSON.stringify(models))
		}
	</script>
</head>

<body>
	<header>
		<h1>Warhammer 40k Army Builder</h1>
		<nav>
			<button onclick="updateTroopTable()">Update Troop Table</button>
			<button onclick="fetchArmy()">My Army</button>
			<button onclick="fetchModelList()">Model List</button>
		</nav>
	</header>

	<main>
		<section id="troops"></section>
		<section id="unit-builder" hidden>
			<select id="model-selector"></select>
			<button onclick="fetchModelStats()">Get Stats</button>
			<button onclick="addModel()">Add</button>
			<table id="model-stats" hidden></table>
			<table id="unit-models"></table>
			<button id="submit-unit" onclick="createUnit()" disabled>Save Unit</button>
		</section>
		<section id="my-army">
			<table id="army-table"></table>
		</section>
	</main>
</body>

</html>